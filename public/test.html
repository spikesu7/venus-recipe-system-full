<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é£Ÿè°±ç”Ÿæˆæµ‹è¯•é¡µé¢</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .form-group { margin: 15px 0; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        select, input { width: 100%; padding: 8px; margin-bottom: 10px; }
        button { background: #007bff; color: white; padding: 10px 20px; border: none; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        .results { margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px; }
        .campus-card { margin: 10px 0; padding: 15px; background: white; border-radius: 5px; border: 1px solid #ddd; }
        .recipe-item { margin: 5px 0; padding: 5px; background: #e9ecef; border-radius: 3px; }
        .loading { text-align: center; color: #666; }
        .error { color: red; }
        .success { color: green; }
    </style>
</head>
<body>
    <div class="container">
        <h1>é‡‘æ˜Ÿé£Ÿè°±ç®¡ç†ç³»ç»Ÿ - æµ‹è¯•é¡µé¢</h1>

        <div class="form-group">
            <label for="campusSelect">é€‰æ‹©å›­åŒº:</label>
            <select id="campusSelect" multiple size="5">
                <!-- å›­åŒºå°†é€šè¿‡JavaScriptåŠ è½½ -->
            </select>
            <small>æŒ‰ä½Ctrlé”®å¯ä»¥é€‰æ‹©å¤šä¸ªå›­åŒº</small>
        </div>

        <div class="form-group">
            <label for="startDate">å¼€å§‹æ—¥æœŸ:</label>
            <input type="date" id="startDate" value="2025-01-13">
        </div>

        <div class="form-group">
            <label for="endDate">ç»“æŸæ—¥æœŸ:</label>
            <input type="date" id="endDate" value="2025-01-14">
        </div>

        <button onclick="generateRecipes()">ç”Ÿæˆé£Ÿè°±</button>
        <button onclick="clearResults()">æ¸…é™¤ç»“æœ</button>

        <div id="status" class="loading"></div>
        <div id="results" class="results" style="display: none;"></div>
    </div>

    <script>
        let campuses = [];

        // é¡µé¢åŠ è½½æ—¶è·å–å›­åŒºæ•°æ®
        async function loadCampuses() {
            try {
                const response = await fetch('/api/campuses');
                const result = await response.json();

                if (result.success) {
                    campuses = result.data;
                    const select = document.getElementById('campusSelect');
                    select.innerHTML = '';

                    campuses.forEach(campus => {
                        const option = document.createElement('option');
                        option.value = campus.id;
                        option.textContent = `${campus.name} (${campus.code})`;
                        select.appendChild(option);
                    });

                    document.getElementById('status').innerHTML = '<div class="success">âœ… æˆåŠŸåŠ è½½ ' + campuses.length + ' ä¸ªå›­åŒº</div>';
                } else {
                    throw new Error('åŠ è½½å›­åŒºå¤±è´¥');
                }
            } catch (error) {
                document.getElementById('status').innerHTML = '<div class="error">âŒ åŠ è½½å›­åŒºå¤±è´¥: ' + error.message + '</div>';
            }
        }

        // ç”Ÿæˆé£Ÿè°±
        async function generateRecipes() {
            const select = document.getElementById('campusSelect');
            const selectedOptions = Array.from(select.selectedOptions);
            const selectedCampuses = selectedOptions.map(option => parseInt(option.value));

            if (selectedCampuses.length === 0) {
                alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªå›­åŒº');
                return;
            }

            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            const statusDiv = document.getElementById('status');
            const resultsDiv = document.getElementById('results');

            statusDiv.innerHTML = '<div class="loading">ğŸ”„ æ­£åœ¨ç”Ÿæˆé£Ÿè°±ï¼Œè¯·ç¨å€™...</div>';
            resultsDiv.style.display = 'none';

            try {
                const response = await fetch('/api/generate-recipes', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        campuses: selectedCampuses,
                        startDate: startDate,
                        endDate: endDate
                    })
                });

                const result = await response.json();

                if (result.success) {
                    statusDiv.innerHTML = '<div class="success">âœ… æˆåŠŸç”Ÿæˆ ' + result.data.totalRecipes + ' ä¸ªé£Ÿè°±ï¼</div>';
                    displayResults(result.data);
                } else {
                    throw new Error(result.message || 'ç”Ÿæˆå¤±è´¥');
                }
            } catch (error) {
                statusDiv.innerHTML = '<div class="error">âŒ ç”Ÿæˆå¤±è´¥: ' + error.message + '</div>';
                console.error('Error:', error);
            }
        }

        // æ˜¾ç¤ºç»“æœ
        function displayResults(data) {
            const resultsDiv = document.getElementById('results');
            let html = '<h2>ç”Ÿæˆçš„é£Ÿè°±</h2>';

            data.results.forEach(campusResult => {
                const campus = campusResult.campus;
                html += '<div class="campus-card">';
                html += '<h3>' + campus.name + ' (' + campus.code + ')</h3>';
                html += '<p><strong>åœ°å€:</strong> ' + campus.address + '</p>';
                html += '<p><strong>å®¹é‡:</strong> ' + campus.capacity + ' äºº</p>';
                html += '<p><strong>ç”Ÿæˆæ•°é‡:</strong> ' + campusResult.stats.totalRecipes + ' ä¸ªé£Ÿè°±</p>';
                html += '<p><strong>æ—¥æœŸèŒƒå›´:</strong> ' + campusResult.stats.dateRange + '</p>';

                html += '<h4>è¯¦ç»†é£Ÿè°±:</h4>';
                campusResult.recipes.forEach(recipe => {
                    const mealTypeMap = {
                        'breakfast': 'æ—©é¤',
                        'lunch': 'åˆé¤',
                        'dinner': 'æ™šé¤'
                    };
                    html += '<div class="recipe-item">';
                    html += '<strong>' + recipe.date + ' ' + mealTypeMap[recipe.meal_type] + ':</strong> ';
                    html += recipe.dish_name;

                    if (recipe.dish_ingredients && recipe.dish_ingredients.length > 0) {
                        html += '<br><small>é£Ÿæ: ' + recipe.dish_ingredients.map(i => i.name + '(' + i.quantity + (i.unit || 'g') + ')').join(', ') + '</small>';
                    }
                    html += '</div>';
                });

                html += '</div>';
            });

            resultsDiv.innerHTML = html;
            resultsDiv.style.display = 'block';
        }

        // æ¸…é™¤ç»“æœ
        function clearResults() {
            document.getElementById('status').innerHTML = '';
            document.getElementById('results').style.display = 'none';
            document.getElementById('results').innerHTML = '';
        }

        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', loadCampuses);
    </script>
</body>
</html>