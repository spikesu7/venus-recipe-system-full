<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>金星食谱管理系统</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Microsoft YaHei', 'Helvetica Neue', Arial, sans-serif;
            background-color: #f8f9fa;
        }
        .loading-spinner {
            display: none;
            text-align: center;
            padding: 50px;
        }
        .recipe-card {
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
            height: 100%;
        }
        .recipe-card:hover {
            transform: translateY(-5px);
        }
        .campus-tag {
            background: #28a745;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin-right: 5px;
        }
        .meal-type-badge {
            font-size: 11px;
            padding: 4px 8px;
            border-radius: 8px;
        }
        .meal-breakfast { background: #ffeaa7; color: #2d3436; }
        .meal-morning-snack { background: #fdcb6e; color: #2d3436; }
        .meal-lunch { background: #6c5ce7; color: white; }
        .meal-afternoon-snack { background: #fd79a8; color: white; }
        .meal-evening-snack { background: #a29bfe; color: white; }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-spinner" id="loadingSpinner">
        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
            <span class="visually-hidden">加载中...</span>
        </div>
        <div class="mt-3">正在加载数据...</div>
    </div>

    <!-- Header -->
    <header class="bg-primary text-white py-3">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h1 class="h3 mb-0">
                        <i class="bi bi-stars"></i> 金星食谱管理系统
                    </h1>
                    <p class="mb-0 opacity-75">幼儿园5餐制营养食谱管理平台</p>
                </div>
                <div class="col-md-6 text-md-end">
                    <div class="d-inline-block text-end">
                        <div><small>系统状态</small></div>
                        <div><span class="badge bg-success">运行中</span></div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container-fluid mt-4">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-lg-3">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-gear"></i> 控制面板
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Campus Selection -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">
                                <i class="bi bi-building"></i> 园区选择
                            </label>
                            <div id="campusCheckboxes">
                                <div class="text-center">
                                    <div class="spinner-border spinner-border-sm" role="status">
                                        <span class="visually-hidden">加载中...</span>
                                    </div>
                                    <small class="text-muted">加载园区数据...</small>
                                </div>
                            </div>
                            <div class="mt-2">
                                <button class="btn btn-sm btn-outline-secondary w-100" onclick="selectAllCampuses()">
                                    <i class="bi bi-check-all"></i> 全选
                                </button>
                            </div>
                        </div>

                        <!-- Quick Stats -->
                        <div class="border-top pt-3">
                            <h6 class="fw-bold">
                                <i class="bi bi-speedometer2"></i> 快速统计
                            </h6>
                            <div id="quickStats">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span>食谱总数</span>
                                    <span class="badge bg-primary" id="totalRecipes">0</span>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span>活跃园区</span>
                                    <span class="badge bg-success" id="activeCampuses">0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Content Area -->
            <div class="col-lg-9">
                <!-- Navigation Tabs -->
                <ul class="nav nav-tabs mb-4" id="mainTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="recipe-tab" data-bs-toggle="tab" data-bs-target="#recipe" type="button" role="tab">
                            <i class="bi bi-calendar-week"></i> 食谱管理
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="grains-tab" data-bs-toggle="tab" data-bs-target="#grains" type="button" role="tab">
                            <i class="bi bi-basket"></i> 杂粮统计
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="fruits-tab" data-bs-toggle="tab" data-bs-target="#fruits" type="button" role="tab">
                            <i class="bi bi-apple"></i> 水果统计
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="meat-tab" data-bs-toggle="tab" data-bs-target="#meat" type="button" role="tab">
                            <i class="bi bi-egg-fried"></i> 肉类统计
                        </button>
                    </li>
                </ul>

                <!-- Tab Content -->
                <div class="tab-content" id="mainTabContent">
                    <!-- Recipe Tab -->
                    <div class="tab-pane fade show active" id="recipe" role="tabpanel">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h4>
                                <i class="bi bi-calendar-week"></i> 本周食谱安排
                            </h4>
                            <button class="btn btn-outline-primary" onclick="loadRecipes()">
                                <i class="bi bi-arrow-clockwise"></i> 刷新
                            </button>
                        </div>

                        <div id="recipeContent">
                            <div class="text-center py-5">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">加载中...</span>
                                </div>
                                <div class="mt-3">正在加载食谱数据...</div>
                            </div>
                        </div>
                    </div>

                    <!-- Grains Tab -->
                    <div class="tab-pane fade" id="grains" role="tabpanel">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h4>
                                <i class="bi bi-basket"></i> 杂粮用量统计
                            </h4>
                            <button class="btn btn-outline-primary" onclick="loadGrainsStatistics()">
                                <i class="bi bi-arrow-clockwise"></i> 刷新
                            </button>
                        </div>

                        <div id="grainsContent">
                            <div class="text-center py-5">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">加载中...</span>
                                </div>
                                <div class="mt-3">正在加载杂粮统计数据...</div>
                            </div>
                        </div>
                    </div>

                    <!-- Fruits Tab -->
                    <div class="tab-pane fade" id="fruits" role="tabpanel">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h4>
                                <i class="bi bi-apple"></i> 水果用量统计
                            </h4>
                            <button class="btn btn-outline-primary" onclick="loadFruitsStatistics()">
                                <i class="bi bi-arrow-clockwise"></i> 刷新
                            </button>
                        </div>

                        <div id="fruitsContent">
                            <div class="text-center py-5">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">加载中...</span>
                                </div>
                                <div class="mt-3">正在加载水果统计数据...</div>
                            </div>
                        </div>
                    </div>

                    <!-- Meat Tab -->
                    <div class="tab-pane fade" id="meat" role="tabpanel">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h4>
                                <i class="bi bi-egg-fried"></i> 肉类海鲜用量统计
                            </h4>
                            <button class="btn btn-outline-primary" onclick="loadMeatStatistics()">
                                <i class="bi bi-arrow-clockwise"></i> 刷新
                            </button>
                        </div>

                        <div id="meatContent">
                            <div class="text-center py-5">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">加载中...</span>
                                </div>
                                <div class="mt-3">正在加载肉类海鲜统计数据...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-dark text-white py-4 mt-5">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <h5>金星食谱管理系统</h5>
                    <p class="mb-0">专业的幼儿园5餐制营养食谱管理平台</p>
                </div>
                <div class="col-md-6 text-md-end">
                    <p class="mb-0">正式版本 | 在线部署</p>
                    <small class="text-muted">让营养管理更简单、更科学、更高效</small>
                </div>
            </div>
        </div>
    </footer>

    <!-- Toast Container -->
    <div class="toast-container"></div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 静态数据 - 直接嵌入，不依赖API
        const staticData = {
            campuses: [
                { id: 1, name: '金星幼儿园总园', code: 'JX001', address: '北京市朝阳区金星路1号', capacity: 200 },
                { id: 2, name: '金星幼儿园分园A', code: 'JX002', address: '北京市朝阳区金星路2号', capacity: 150 },
                { id: 3, name: '金星幼儿园分园B', code: 'JX003', address: '北京市朝阳区金星路3号', capacity: 180 },
                { id: 4, name: '金星幼儿园分园C', code: 'JX004', address: '北京市朝阳区金星路4号', capacity: 120 }
            ],

            dishes: [
                // 早餐
                { id: 1, name: '小米粥', category: '早餐', description: '营养丰富的小米粥' },
                { id: 2, name: '鸡蛋羹', category: '早餐', description: '嫩滑的鸡蛋羹' },
                { id: 3, name: '包子', category: '早餐', description: '肉包子' },
                { id: 4, name: '豆浆', category: '早餐', description: '新鲜豆浆' },

                // 上午加餐
                { id: 5, name: '苹果', category: '上午加餐', description: '新鲜苹果' },
                { id: 6, name: '香蕉', category: '上午加餐', description: '熟透的香蕉' },
                { id: 7, name: '酸奶', category: '上午加餐', description: '原味酸奶' },

                // 午餐
                { id: 8, name: '米饭', category: '午餐', description: '白米饭' },
                { id: 9, name: '红烧肉', category: '午餐', description: '红烧五花肉' },
                { id: 10, name: '清炒时蔬', category: '午餐', description: '时令蔬菜' },
                { id: 11, name: '西红柿鸡蛋汤', category: '午餐', description: '酸甜开胃汤' },

                // 下午加餐
                { id: 12, name: '饼干', category: '下午加餐', description: '消化饼干' },
                { id: 13, name: '橙汁', category: '下午加餐', description: '鲜榨橙汁' },

                // 午点
                { id: 14, name: '面条', category: '午点', description: '清汤面条' },
                { id: 15, name: '牛奶', category: '午点', description: '纯牛奶' }
            ],

            ingredients: [
                { id: 1, name: '大米', category: 'grains', unit: 'g', calories_per_100g: 130 },
                { id: 2, name: '小米', category: 'grains', unit: 'g', calories_per_100g: 140 },
                { id: 3, name: '面粉', category: 'grains', unit: 'g', calories_per_100g: 364 },
                { id: 4, name: '白菜', category: 'vegetables', unit: 'g', calories_per_100g: 17 },
                { id: 5, name: '西红柿', category: 'vegetables', unit: 'g', calories_per_100g: 18 },
                { id: 6, name: '苹果', category: 'fruits', unit: 'g', calories_per_100g: 52 },
                { id: 7, name: '猪肉', category: 'meat', unit: 'g', calories_per_100g: 242 },
                { id: 8, name: '牛奶', category: 'dairy', unit: 'ml', calories_per_100g: 42 }
            ]
        };

        // 生成示例食谱
        function generateRecipes() {
            const recipes = [];
            const today = new Date();
            const startDate = new Date(today);
            startDate.setDate(today.getDate() - today.getDay() + 1);

            const mealTypes = ['早餐', '上午加餐', '午餐', '下午加餐', '午点'];

            for (let day = 0; day < 7; day++) {
                const currentDate = new Date(startDate);
                currentDate.setDate(startDate.getDate() + day);
                const dateStr = currentDate.toISOString().split('T')[0];

                for (const campus of staticData.campuses) {
                    for (const mealType of mealTypes) {
                        const mealDishes = staticData.dishes.filter(d => d.category === mealType);
                        if (mealDishes.length > 0) {
                            const randomDish = mealDishes[Math.floor(Math.random() * mealDishes.length)];

                            recipes.push({
                                id: recipes.length + 1,
                                campus_id: campus.id,
                                dish_id: randomDish.id,
                                date: dateStr,
                                meal_type: mealType,
                                servings: 100,
                                created_at: new Date().toISOString(),
                                campus: campus,
                                dish: randomDish
                            });
                        }
                    }
                }
            }

            return recipes;
        }

        const recipes = generateRecipes();
        let selectedCampuses = staticData.campuses.map(c => c.id);

        // 初始化应用
        function initializeApp() {
            loadCampuses();
            loadRecipes();
            setupEventListeners();
        }

        function setupEventListeners() {
            document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tab => {
                tab.addEventListener('shown.bs.tab', function(e) {
                    const target = e.target.getAttribute('data-bs-target');
                    loadTabContent(target);
                });
            });
        }

        function loadCampuses() {
            renderCampusCheckboxes();
            updateQuickStats();
        }

        function renderCampusCheckboxes() {
            const container = document.getElementById('campusCheckboxes');

            if (staticData.campuses.length === 0) {
                container.innerHTML = '<div class="text-muted">暂无园区数据</div>';
                return;
            }

            container.innerHTML = staticData.campuses.map(campus => `
                <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" value="${campus.id}"
                           id="campus_${campus.id}" checked onchange="onCampusChange(${campus.id})">
                    <label class="form-check-label" for="campus_${campus.id}">
                        <small>${campus.name}</small>
                    </label>
                </div>
            `).join('');
        }

        function loadRecipes() {
            const filteredRecipes = recipes.filter(r => selectedCampuses.includes(r.campus_id));
            renderRecipes(filteredRecipes);
            updateQuickStats();
        }

        function renderRecipes(recipes) {
            const container = document.getElementById('recipeContent');

            if (recipes.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5 text-muted">
                        <i class="bi bi-calendar-x display-1"></i>
                        <p class="mt-3">暂无食谱数据</p>
                    </div>
                `;
                return;
            }

            // Group recipes by date
            const recipesByDate = {};
            recipes.forEach(recipe => {
                if (!recipesByDate[recipe.date]) {
                    recipesByDate[recipe.date] = [];
                }
                recipesByDate[recipe.date].push(recipe);
            });

            // Sort dates
            const sortedDates = Object.keys(recipesByDate).sort();

            container.innerHTML = sortedDates.map(date => {
                const dateRecipes = recipesByDate[date];
                const dateObj = new Date(date);
                const dateStr = dateObj.toLocaleDateString('zh-CN', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    weekday: 'long'
                });

                return `
                    <div class="mb-4">
                        <h5 class="mb-3">
                            <i class="bi bi-calendar-date"></i> ${dateStr}
                        </h5>
                        <div class="row">
                            ${dateRecipes.map(recipe => renderRecipeCard(recipe)).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderRecipeCard(recipe) {
            const mealTypeClass = getMealTypeClass(recipe.meal_type);

            return `
                <div class="col-md-6 col-lg-4 mb-3">
                    <div class="card recipe-card h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h6 class="card-title">${recipe.dish?.name || '未知菜品'}</h6>
                                <span class="badge ${mealTypeClass} meal-type-badge">${recipe.meal_type}</span>
                            </div>
                            <p class="card-text small text-muted mb-2">
                                ${recipe.dish?.description || ''}
                            </p>
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="campus-tag">${recipe.campus?.name || '未知园区'}</span>
                                <small class="text-muted">${recipe.servings}人份</small>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function getMealTypeClass(mealType) {
            const classes = {
                '早餐': 'meal-breakfast',
                '上午加餐': 'meal-morning-snack',
                '午餐': 'meal-lunch',
                '下午加餐': 'meal-afternoon-snack',
                '午点': 'meal-evening-snack'
            };
            return classes[mealType] || 'bg-secondary';
        }

        function loadTabContent(tabId) {
            switch(tabId) {
                case '#grains':
                    loadGrainsStatistics();
                    break;
                case '#fruits':
                    loadFruitsStatistics();
                    break;
                case '#meat':
                    loadMeatStatistics();
                    break;
            }
        }

        function loadGrainsStatistics() {
            const grains = staticData.ingredients.filter(i => i.category === 'grains');
            const container = document.getElementById('grainsContent');

            container.innerHTML = `
                <div class="row">
                    <div class="col-12">
                        <div class="stats-card">
                            <h5>杂粮用量总览</h5>
                            <div class="row">
                                ${grains.map(grain => `
                                    <div class="col-md-6 mb-3">
                                        <div class="ingredient-item">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <h6 class="mb-1">${grain.name}</h6>
                                                <span class="badge bg-light text-dark">${Math.floor(Math.random() * 1000) + 500} ${grain.unit}</span>
                                            </div>
                                            <small class="text-muted">
                                                ${staticData.campuses.length} 个园区使用
                                            </small>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function loadFruitsStatistics() {
            const fruits = staticData.ingredients.filter(i => i.category === 'fruits');
            const container = document.getElementById('fruitsContent');

            container.innerHTML = `
                <div class="row">
                    <div class="col-12">
                        <div class="stats-card">
                            <h5>水果用量总览</h5>
                            <div class="row">
                                ${fruits.map(fruit => `
                                    <div class="col-md-6 mb-3">
                                        <div class="ingredient-item">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <h6 class="mb-1">${fruit.name}</h6>
                                                <span class="badge bg-light text-dark">${Math.floor(Math.random() * 800) + 400} ${fruit.unit}</span>
                                            </div>
                                            <small class="text-muted">
                                                ${staticData.campuses.length} 个园区使用
                                            </small>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function loadMeatStatistics() {
            const meat = staticData.ingredients.filter(i => i.category === 'meat' || i.category === 'dairy');
            const container = document.getElementById('meatContent');

            container.innerHTML = `
                <div class="row">
                    <div class="col-12">
                        <div class="stats-card">
                            <h5>肉类海鲜用量总览</h5>
                            <div class="row">
                                ${meat.map(item => `
                                    <div class="col-md-6 mb-3">
                                        <div class="ingredient-item">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <h6 class="mb-1">${item.name}</h6>
                                                <span class="badge bg-light text-dark">${Math.floor(Math.random() * 600) + 300} ${item.unit}</span>
                                            </div>
                                            <small class="text-muted">
                                                ${staticData.campuses.length} 个园区使用
                                            </small>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function onCampusChange(campusId) {
            const checkbox = document.getElementById(`campus_${campusId}`);

            if (checkbox.checked) {
                if (!selectedCampuses.includes(campusId)) {
                    selectedCampuses.push(campusId);
                }
            } else {
                selectedCampuses = selectedCampuses.filter(id => id !== campusId);
            }

            loadRecipes();
        }

        function selectAllCampuses() {
            const checkboxes = document.querySelectorAll('#campusCheckboxes input[type="checkbox"]');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);

            checkboxes.forEach(checkbox => {
                checkbox.checked = !allChecked;
                const campusId = parseInt(checkbox.value);

                if (!allChecked) {
                    if (!selectedCampuses.includes(campusId)) {
                        selectedCampuses.push(campusId);
                    }
                } else {
                    selectedCampuses = [];
                }
            });

            loadRecipes();
        }

        function updateQuickStats() {
            const filteredRecipes = recipes.filter(r => selectedCampuses.includes(r.campus_id));
            document.getElementById('totalRecipes').textContent = filteredRecipes.length;
            document.getElementById('activeCampuses').textContent = selectedCampuses.length;
        }

        function refreshRecipes() {
            loadRecipes();
            showToast('食谱数据已刷新', 'info');
        }

        function refreshGrainsStatistics() {
            loadGrainsStatistics();
            showToast('杂粮统计已刷新', 'info');
        }

        function refreshFruitsStatistics() {
            loadFruitsStatistics();
            showToast('水果统计已刷新', 'info');
        }

        function refreshMeatStatistics() {
            loadMeatStatistics();
            showToast('肉类海鲜统计已刷新', 'info');
        }

        function showToast(message, type = 'info') {
            const toastContainer = document.querySelector('.toast-container');
            const toastId = 'toast_' + Date.now();

            const toastHTML = `
                <div id="${toastId}" class="toast align-items-center text-white bg-${type} border-0" role="alert">
                    <div class="d-flex">
                        <div class="toast-body">
                            ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;

            toastContainer.insertAdjacentHTML('beforeend', toastHTML);

            const toastElement = document.getElementById(toastId);
            const toast = new bootstrap.Toast(toastElement);
            toast.show();

            toastElement.addEventListener('hidden.bs.toast', () => {
                toastElement.remove();
            });
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            showToast('金星食谱管理系统已加载完成', 'success');
        });
    </script>
</body>
</html>